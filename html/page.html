<tal:block metal:define-macro="icing">
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
                               "http://www.w3.org/TR/html4/strict.dtd">
<html tal:define="
   language        python: utils.set_language (request.client, db)
 ; uname           python: str (request.user.username)
 ; classname       context/_classname|db/user/_classname
 ; listclass       classname
 ; Classname       python: i18n.gettext (classname)
 ; formname        python: 'itemSynopsis'
 ; ctx_id          python: (context and context.id) or ''
 ; head_title      python: Classname + ' ' + ctx_id
 ; klass           python: db [classname] or default
 ; bclass          python: db._db.getclass (classname) or default
 ; login           request/form/:login/value | nothing
 ; is_user         python: request.user.username!='anonymous'
                           or (   'issue' in db._db.classes
                              and db.issue.is_view_ok ()
                              and not login
                              )
 ; labelprop       klass/_klass/labelprop
 ; props           python: klass._klass.getprops ()
 ; has_msgs        python: 'messages'    in props
 ; has_invoices    python: 'invoices'    in props
 ; has_letters     python: 'letters'     in props
 ; has_files       python: 'files'       in props
 ; want_files      python: True
 ; has_resp        python: 'responsible' in props
 ; has_nosy        python: 'nosy'        in props
 ; nosy_stati      python: None
 ; use_labelprop   python: 1
 ; approval_for    python: (   'time_record' in db._db.classes
                           and utils.approval_for (db, True)
                           )
 ; uid             python: db._db.getuid ()
 ; default_query   string::action=searchwithtemplate&@startwith=0&@pagesize=20&@sort=id&@sortdir=on&@columns=id,title,responsible
 ; n_sort          python: 2
 ; tplate_args     python: {}
 ; msg_box_height  python: 8
 ; may_remove_msgs python: False
 ; abo_adrtype     python: utils.valid_adr_types (db, adr_type_cat = 'ABO')
 ; terse           python: utils.get_from_form (request, 'terse')
 ; quiet           python: utils.get_from_form (request, 'quiet')
 ; show_creation   python: True
 ; form_class      python: 'form'
 ; queryform_class python: ''
 ; form_template   python: 'item'
 ; csv_action      python: 'export_csv_names'
 ; leave_stats     python: 'leave_status' in db._db.classes and tuple
                            (db._db.leave_status.lookup (i)
                             for i in ('submitted', 'cancel requested')
                            ) or ()
 ; typecat         python: (   'adr_type_cat' in db._db.classes
                           and ','.join (db._db.adr_type_cat.getnodeids ())
                           )
 ; s_stati         python: 'status' in db._db.classes
                   and ','.join (s.id for s in db.status.filter ()
                                 if s.name not in
                                    ('closed', 'postponed', 'suspended')
                                )
 ; default_queries python:
   { ('abo', '')        : '@columns=id,aboprice,amount,begin,'
                          'end,subscriber.lastname,payer.lastname&'
                          '@sort=-id&@pagesize=20&@startwith=0&'
                          '@quiet=1&@terse=1'
   , ('abo_type', '')   : '@columns=name,description,period,order,adr_type,'
                          'invoice_template&@sort=order&@pagesize=20&'
                          '@startwith=0'
   , ('abo_price', '')  : '@startwith=0&@pagesize=20&@sort=name&'
                          '@columns=name,amount,invoice_group,invoice_template'
   , ('address', '')    : '@quiet=1&@startwith=0&@pagesize=20&'
                          '@sort=lookalike_lastname,lookalike_firstname&'
                          '@columns=salutation,title,id,lastname,firstname,'
                          'country,street,postalcode,city&'
                          '@filter=valid&valid=1&@search_text=&'
                          '@queryname=&@terse=1'
   , ('adr_type', '')   : '@columns=id,code,description,typecat&'
                          '@sort=code&@filter=typecat&@pagesize=50&'
                          '@startwith=0&typecat=%s' % typecat
   , ('alias', '')      : '@columns=name,alias_to_alias,alias_to_user&'
                          '@pagesize=500&@startwith=0'
   , ('cost_center', '')
                        : '@columns=organisation_id,cost_center_group_id'
                          ',id,name,status,organisation&'
                          '@sort=name&@group=cost_center_group&'
                          '@filter=status&@pagesize=20&@startwith=0&'
                          'status=5,1,2,4'
   , ('category', '')   : '@columns=name,description,responsible,prodcat,'
                          'valid,cert_sw&@sort=name&@filter=valid&'
                          '@pagesize=200&@startwith=0&valid=1'
   , ('contact', '')    : utils.contact_query (db)
   , ('cust_supp', '')  : '@pagesize=50&@startwith=0&'
                          '@columns=id,name,description,tax_id,status,attendant'
   , ('customer', '')   : '@columns=%s&@sort=name&@filter=is_valid&'
                          '@pagesize=20&@startwith=0&is_valid=yes'
                           % ','.join
                              (c for c in ( 'name', 'salutation', 'title'
                                          , 'lastname', 'firstname', 'function'
                                          , 'adr_type'
                                          )
                                 if 'customer' in db._db.classes
                                 and c in db._db.customer.properties
                              )
   , ('customer_agreement', '') :
                          '@pagesize=50&@startwith=0&'
                          '@columns=id,customer,product,'
                          'product.product_family.name'
   , ('daily_record', '')
                        : '@columns=id,user,date,status&@sort=-id&'
                          '@filter=user,date&@pagesize=20&@startwith=0&'
                          'date=.-1d%%3B.%%2B1d&user=%s' % uid
   , ('device', '')     : '@columns=device_group,adr,name,dev,cls,version&'
                          '@sort=order&@pagesize=20&@startwith=0'
   , ('daily_record_freeze', '')
                        : '@columns=id,date,balance,validity_date,frozen&'
                          '@sort=-date&@group=user&@filter=user&'
                          '@pagesize=20&@startwith=0&'
                          'user=%s' % uid
   , ('discount_group', '')
                        : '@columns=id,name,currency&'
                          '@sort=-id&@pagesize=20&@startwith=0'
   , ('doc', '')        : '@columns=title,document_nr,artefact,department&'
                          '@sort=title&@filter=status&status=-1,1,2,3'
   , ('dyndns', '')     : '@action=singleton'
   , ('ext_tracker_state', '')
                        : '@columns=id,issue.category,issue.title,issue.area,'
                          'issue.kind,issue.status,'
                          'issue.composed_of.id,issue.part_of.id&'
                          '@sort=issue.category&@group=-issue.effective_prio&'
                          '@filter=issue.status,issue.responsible&@pagesize=50&'
                          '@startwith=0&issue.status=%s&issue.responsible=%s'
                          % (s_stati, uid)
   , ('group', '')      : '@columns=name,gid,description,org_location&'
                          '@sort=-id&@pagesize=500&@startwith=0'
   , ('invoice', '')    : '@quiet=1&@terse=1&@columns=invoice_no,'
                          'period_start,period_end,amount,currency,'
                          'balance_open,n_sent,payer.lastname,'
                          'subscriber.lastname,abo&'
                          '@sort=-period_start&@filter=open&'
                          '@pagesize=50&@startwith=0&open=1'
   , ('issue', '')      : '@columns=id,category,title,area,kind,status,'
                          'composed_of.id,part_of.id&'
                          '@sort=category&@group=-effective_prio&'
                          '@filter=status,responsible&@pagesize=50&'
                          '@startwith=0&status=%s&responsible=%s'
                          % (s_stati, uid)
   , ('it_category', ''): '@columns=id,name,description,valid&'
                          '@sort=name&@filter=valid&'
                          '@pagesize=50&@startwith=0&valid=1'
   , ('it_issue', '')   : '@columns=id,title,responsible,stakeholder,it_prio&'
                          '@sort=-id&@group=status&@filter=stakeholder,status&'
                          '@pagesize=50&@startwith=0&'
                          'status=1,2,3&stakeholder=%s' % uid
   , ('kpm', '')        : '@columns=first_day,last_day,status,'
                          '@columns=issue,issue.id,reproduceable,'
                          'kpm_hw_variant,safety_relevant,kpm_occurrence,'
                          'kpm_tag&@sort=-id&@pagesize=20&@startwith=0'
   , ('leave_submission', '')
                        : '@columns=first_day,last_day,status,'
                          'time_wp.project,time_wp&@filter=user&'
                          '@sort=-first_day&@pagesize=20&@startwith=0&'
                          'user=%s' % uid
   , ('leave_submission', 'approve_hr')
                        : '@columns=first_day,last_day,status,'
                          'time_wp.project,time_wp&'
                          '@filter=approval_hr,status&'
                          '@sort=user,first_day&@pagesize=20&@startwith=0&'
                          'approval_hr=yes&status=%s' % ','.join (leave_stats)
   , ('timesheet', '')  : ''
   , ('letter', '')     : '@columns=id,subject,date,address.lastname,'
                          'address.firstname&'
                          '@sort=-date&@pagesize=20&@startwith=0&'
                          '@quiet=1&@terse=1'
   , ('measurement', ' (CSV)')
                        : '@sort=date&@filter=date,sensor.is_app_sensor,'
                          'sensor.do_logging&date=.-1w%3B&'
                          'sensor.is_app_sensor=yes&sensor.do_logging=yes'
   , ('measurement', ''): utils.measurement_query
   , ('overtime_correction', '')
                       : '@columns=id,user,date,value,comment&'
                         '@sort=-date&@filter=user&@pagesize=20&@startwith=0&'
                         'user=%s' % uid
   , ('payment', '')    : ':columns=date_payed,amount,invoice,receipt_no,'
                          'invoice.payer.lastname,invoice.payer.firstname,'
                          'invoice.currency,invoice.amount,invoice.abo&'
                          ':sort=date_payed&:pagesize=20&:startwith=0&'
                          '@quiet=1&@terse=1'
   , ('person', '')     : '@quiet=1&@startwith=0&@pagesize=20&'
                          '@sort=address.postalcode,address.city,'
                          'lookalike_lastname,lookalike_firstname&'
                          '@columns=salutation,title,id,lastname,firstname,'
                          'function,address.postalcode,address.city&'
                          '@filter=valid&valid=1&@search_text=&'
                          '@queryname='
   , ('prodcat', '')    : '@columns=name,level&'
                          ':filter=status&:pagesize=50&:startwith=0&status=1'
   , ('product', '')    : '@columns=sap_material,name,description,'
                          'product_group,measuring_unit,'
                          'packaging_unit,minimum_inventory&'
                          ':filter=status&:pagesize=50&:startwith=0&status=1'
   , ('pr_supplier', '')
                        : '@columns=id,name,sap_ref'
                          '&@sort=name&@pagesize=20&@startwith=0'
   , ('pr_supplier_rating', '')
                        : '@columns=id,supplier,organisation,rating'
                          '&@sort=supplier&@pagesize=20&@startwith=0'
   , ('purchase_request', '')
                        : '@columns=id,title,purchase_type,time_project,'
                          'time_project.description,delivery_deadline,'
                          'purchase_type,total_cost,pr_currency,status&'
                          '@sort=-delivery_deadline&@filter=requester&'
                          '@pagesize=20&@startwith=0&'
                          'requester=%s' % uid
   , ('purchase_type', '')
                        : '@columns=id,order,name,pr_view_roles,pr_roles,'
                          'pr_forced_roles&'
                          '@sort=order&@filter=valid&'
                          '@pagesize=20&@startwith=0&'
                          'valid=1'
   , ('public_holiday', '')
                        : '@columns=id,name,description,date,locations,is_half&'
                          '@sort=date&@filter=date&@pagesize=20&@startwith=0&'
                          'date=.%3B'
   , ('qsl', '')        : '@columns=qsl_type,date_recv,date_sent,qso.call,'
                          'qso.band,qso.qso_start,qso.qso_end,qso.rst_rcvd,'
                          'qso.mode,qso.owner&'
                          '@sort=-date_sent,-date_recv,qso.call&'
                          '@pagesize=20&@startwith=0'
   , ('qso', '')        : '@columns=call,band,qso_start,qso_end,rst_rcvd,'
                          'mode,owner&'
                          '@sort=-qso_end&@pagesize=20&@startwith=0'
   , ('sap_cc', '')     : '@columns=deputy,description,id,name,'
                          'organisation,responsible,'
                          'valid,sync_id'
   , ('sensor', '')     : utils.sensor_query
   , ('summary_report', 'staff')
                        : '@startwith=0&@pagesize=50&'
                          '@filter=summary_type,date,user&summary_type=2,4&'
                          'user=%s&date=%s%%3B.' %
                          (uid, utils.monthstart_twoweeksago ())
   , ('summary_report', '')
                        : '@dontshowquery=1&@columns=user,time_wp,summary&'
                          '@filter=user,summary_type,status,date,show_empty,'
                          'show_all_users,show_missing&'
                          '@pagesize=50&@startwith=0&status=6,3,1,2&'
                          'date=%s%%3B.&summary_type=2,4&user=%s&'
                          'show_empty=no&show_all_users=no&show_missing=no' %
                          (utils.monthstart_twoweeksago (), uid)
   , ('support', '')    : '@columns=id,category,title,status,responsible,'
                          'customer&@sort=category&@group=-prio&'
                          '@filter=status,responsible&'
                          '@pagesize=20&@startwith=0&status=1,3&'
                          'responsible=%s' % uid
   , ('time_project', '')
                        : '@columns=name,responsible,organisation,cost_center'
                          ',status&@sort=name&@filter=status&@pagesize=20&'
                          '@startwith=0&status=1,2'
   , ('time_record', '')
                        : '@columns=daily_record.user,daily_record.date,'
                          'daily_record.status,wp.project,wp,time_activity,'
                          'work_location,duration,tr_duration,comment&'
                          '@sort=daily_record.user,daily_record.date,'
                          'wp.project,wp&@filter=daily_record.user,'
                          'daily_record.date&@pagesize=50&@startwith=0&'
                          'daily_record.user=%s&daily_record.date=.-30d%%3B.'
                           % (uid,)
   , ('time_wp', '')    : '@columns=id,name,wp_no,responsible,project,time_start'
                          ',time_end,cost_center&@sort=name&@filter=bookers&'
                          '@pagesize=20&@startwith=0&bookers=%s' % uid
   , ('time_wp_group', '')
                        : '@columns=id,name,description,wps&@sort=name&'
                          '@pagesize=20&@startwith=0'
   , ('tmplate', '')    : '@columns=id,name,tmplate_status&@sort=name&'
                          '@pagesize=20&@startwith=0'
   , ('transceiver', '')
                        : '@columns=id,name,adr&@sort=name,adr&'
                          '@pagesize=20&@startwith=0'
   , ('transceiver', 'del')
                        : ''
   , ('user', '')       : '@columns=%s%s&@sort=%s&'
                          '@filter=status&@pagesize=5000&@startwith=0&status=1'
                          % ( ','.join
                              (n for n in
                               ( 'lastname'
                               , 'firstname'
                               , 'nickname'
                               , 'username'
                               , 'room'
                               , 'position'
                               , 'supervisor'
                               )
                              if n in db._db.user.properties
                              )
                            , ['', ',realname']
                              ['lastname' not in db._db.user.properties]
                            , ['username', 'lastname']
                              ['lastname' in db._db.user.properties]
                            )
   , ('user_dynamic', '')
                       : '@columns=id,user,valid_from,org_location&@sort=-id&'
                         '@pagesize=20&@startwith=0'
   , ('user_contact', '')
                        : '@columns=room,user.firstname,user.lastname,'
                          'user.nickname,contact,contact_type&'
                          '@sort=room,user.lastname,user.firstname&'
                          '@filter=user.status,contact_type&'
                          '@pagesize=5000&@startwith=0&'
                          'user.status=1&contact_type=2,3,5,4'
   , ('user_contact', 'grouped')
                        : '@columns=user.nickname,user.username,contact,'
                          'contact_type&'
                          '@sort=room,user.lastname,user.firstname&'
                          '@group=user.lastname,user.firstname&'
                          '@filter=user.status,contact_type&'
                          '@pagesize=5000&@startwith=0&'
                          'user.status=1&contact_type=2,3,5,6'
   , ('vacation_report', '')
                        : '@columns=additional_submitted&@filter=user&'
                          '@pagesize=200&@startwith=0&'
                          'user=%s' % uid
   , ('vacation_correction', '')
                        : '@columns=user,contract_type,date,absolute,days'
                          'contact_type&'
                          '@sort=user,date&'
                          '@filter=user&'
                          '@pagesize=200&@startwith=0&'
                          'user=%s' % uid
   }
 ; new_issue     python: [
    '?@template=item&needs_doc=yes&@note='
    'Current%20behavior%3A%0AWhat%20is%20the%20current%20status%3F%20What%20is%20wrong%3F%0A%0AExpected%20behavior%3A%0AHow%20should%20it%20be%3F%20If%20possible%2C%20add%20a%20reference%20to%20a%20specification%20or%20a%0Atest%20case.%0A%0AReproducibility%3A%0AIs%20the%20erroneous%20behavior%20reproducible%3F%20How%3F%0ADocument%20which%20branches%20are%20affected.%0A%0AIf%20the%20status%20is%20set%20to%20%22open%22%20or%20%22escalated%22%2C%20write%20down%20the%20analysis%0Aand%20decision.%20Dont%27t%20forget%20to%20fill%20in%20the%20Release/Version%20of%20the%0Aaffected%20product%20and%20to%20attach%20all%20files%20needed%20to%20reproduce%20the%0Aproblem.%0A', '?@template=item'][bool
    ('priority' in db._db.classes)]
 ; menu_time     python:
   ( ( ('abo',                 'Edit',   '?@template=item', 1)
     , ('abo_type',            'Edit',   '?@template=item', 1)
     , ('abo_price',           'Edit',   '?@template=item&valid=1', 1)
     , ( 'address'
       , 'Edit'
       , '?@template=item'
       , 'person' not in db._db.classes
       )
     , ('adr_type_cat',        'Create', '?@template=item', 1)
     , ('adr_type',            'Create', '?@template=item', 1)
     , ('alias',               'Edit', '?@template=item&use_in_ln=True', 1)
     , ('antenna',             'Edit',   '?@template=item', 1)
     , ('area',                'Edit',   '?@template=item', 1)
     , ('artefact',            'Edit',   '?@template=item', 1)
     , ('category',            'Edit',   '?@template=item', 1)
     , ('contact_type',        'Edit',   '?@template=item', 1)
     , ('contract_type',       'Edit',   '?@template=item', 1)
     , ('cost_center',         'Edit',   '?@template=item', 1)
     , ('cost_center_group',   'Edit',   '?@template=item', 1)
     , ('cost_center_status',  'Edit',   '?@template=item', 1)
     , ('currency',            'Edit',   '?@template=item', 1)
     , ('customer_agreement',  'Edit',   '?@template=item', 1)
     , ('customer',            'Create', '?@template=item', 1)
     , ('customer_group',      'Edit',   '?@template=item', 1)
     , ('customer_status',     'Edit',   '?@template=item', 1)
     , ('customer_type',       'Edit',   '?@template=item', 1)
     , ('cust_supp',           'Edit',   '?@template=item', 1)
     , ('daily_record_freeze', 'Edit',   '?@template=item&frozen=1', 1)
     , ('daily_record',         None,    '',                1)
     , ('daily_record_status', 'Edit',   '?@template=item', 1)
     , ('department',          'Edit',   '?@template=item', 1)
     , ('device',              'Create', '?@template=item', 1)
     , ('device_group',        'Edit',   '?@template=item', 1)
     , ('discount_group',      'Edit',   '?@template=item', 1)
     , ('dispatch_type',       'Edit',   '?@template=item', 1)
     , ('dns_record_type',     'Edit',   '?@template=item', 1)
     , ('doc',                 'Edit',   '?@template=item', 1)
     , ('doc_issue_status',    'Edit',   '?@template=item', 1)
     , ('dyndns',              'Edit',   '?@action=singleton', 1)
     , ('external_company',    'Edit',   '?@template=item', 1)
     , ('group',               'Edit',   '?@template=item', 1)
     , ('ham_band',            'Edit',   '?@template=item', 1)
     , ('ham_mode',            'Edit',   '?@template=item', 1)
     , ('infosec_level',       'Edit',   '?@template=item', 1)
     , ('invoice_dispatch',    'Edit',   '?@template=item', 1)
     , ('invoice_group',       'Edit',   '?@template=item', 1)
     , ('invoice_template',    'Edit',   '?@template=item', 1)
     , ('ip_subnet',           'View',   '?@template=item', 1)
     , ('issue',               'Edit',   new_issue,         1)
     , ('it_category',         'Edit',   '?@template=item', 1)
     , ('it_int_prio',         'Edit',   '?@template=item', 1)
     , ('it_issue',            'Edit',   '?@template=item', 1)
     , ('it_issue_status',     'Edit',   '?@template=item', 1)
     , ('it_prio',             'Edit',   '?@template=item', 1)
     , ( 'it_project'
       , 'Edit'
       , '?@template=item&confidential=1'
       , utils.user_has_role (db._db, db._db.getuid (), 'IT')
       )
     , ('it_project_status',   'Edit',   '?@template=item', 1)
     , ('it_request_type',     'Edit',   '?@template=item', 1)
     , ('keyword',             'Edit',   '?@template=item', 1)
     , ('kind',                'Edit',   '?@template=item', 1)
     , ('kpm_function',        'Edit',   '?@template=item', 1)
     , ('kpm_hw_variant',      'Edit',   '?@template=item', 1)
     , ('kpm_occurrence',      'Edit',   '?@template=item', 1)
     , ('kpm_release',         'Edit',   '?@template=item', 1)
     , ('kpm_tag',             'Edit',   '?@template=item', 1)
     , ( 'leave_submission'
       , 'Edit'
       , '?@template=item'
       , utils.user_has_role (db._db, db._db.getuid (), 'HR-vacation')
       )
     , ('legalclient',         'Edit',   '?@template=item', 1)
     , ('location',            'Edit',   '?@template=item', 1)
     , ('mailgroup',           'Edit',   '?@template=item', 1)
     , ('measurement',         'Create', '?@template=item', 1)
     , ('measuring_unit',      'Edit',   '?@template=item', 1)
     , ('msg_keyword',         'Edit',   '?@template=item', 1)
     , ('operating_system',    'View',   '?@template=item', 1)
     , ('organisation',        'Edit',   '?@template=item', 1)
     , ('org_location',        'View',   '?@template=item', 1)
     , ('overtime_correction', 'Edit',   '?@template=item', 1)
     , ('overtime_period',     'Edit',   '?@template=item', 1)
     , ('packaging_unit',      'Edit',   '?@template=item', 1)
     , ('person',              'Edit',   '?@template=item', 1)
     , ('pharma_ref',          'Edit',   '?@template=item', 1)
     , ('pr_currency',         'Edit',   '?@template=item', 1)
     , ('position',            'Edit',   '?@template=item', 1)
     , ('pr_approval_config',  'Edit',   '?@template=item', 1)
     , ('pr_approval_order',   'Edit',   '?@template=item', 1)
     , ('pr_rating_category',  'Edit',   '?@template=item', 1)
     , ('pr_supplier',         'Edit',   '?@template=item', 1)
     , ('pr_supplier_rating',  'Edit',   '?@template=item', 1)
     , ('proceeds_group',      'Edit',   '?@template=item', 1)
     , ('product',             'Edit',   '?@template=item', 1)
     , ('product_family',      'Edit',   '?@template=item', 1)
     , ('product_group',       'Edit',   '?@template=item', 1)
     , ('product_status',      'Edit',   '?@template=item', 1)
     , ('project_type',        'Edit',   '?@template=item', 1)
     , ('public_holiday',      'Edit',   '?@template=item', 1)
     , ('purchase_request',    'Create', utils.pr_justification (), 1)
     , ('purchase_type',       'Edit',   '?@template=item', 1)
     , ('qsl_status',          'Edit',   '?@template=item', 1)
     , ('qsl_type',            'Edit',   '?@template=item', 1)
     , ('qso',                 'Edit',   '?@template=item', 1)
     , ('query',               'Edit',   '?@template=item', 1)
     , ('reference',           'Edit',   '?@template=item', 1)
     , ('reporting_group',     'Edit',   '?@template=item', 1)
     , ('room',                'Edit',   '?@template=item', 1)
     , ('safety_level',        'Edit',   '?@template=item', 1)
     , ('sales_conditions',    'Edit',   '?@template=item', 1)
     , ('sap_cc',              'Edit',   '?@template=item', 1)
     , ('sensor',              'Create', '?@template=item', 1)
     , ('severity',            'Edit',   '?@template=item', 1)
     , ('shelf_life_code',     'Edit',   '?@template=item', 1)
     , ('status',              'Edit',   '?@template=item', 1)
     , ('status_transition',   'Edit',   '?@template=item', 1)
     , ('summary_report',      None,     '',                1)
     , ('sup_classification',  'Edit',   '?@template=item', 1)
     , ('sup_warranty',        'Edit',   '?@template=item', 1)
     , ('supplier_group',      'Edit',   '?@template=item', 1)
     , ('supplier_status',     'Edit',   '?@template=item', 1)
     , ('support',             'Create', '?@template=item', 1)
     , ('sup_status',          'Edit',   '?@template=item', 1)
     , ('test_level',          'Edit',   '?@template=item', 1)
     , ('time_activity',       'Edit',   '?@template=item', 1)
     , ('time_project',        'Edit', '?@template=item&op_project=True', 1)
     , ('time_project_status', 'Edit',   '?@template=item', 1)
     , ('time_record',          None,    '',                1)
     , ('time_wp_group',       'Edit',   '?@template=item', 1)
     , ('time_wp',              None,    '',                1)
     , ('tmplate',             'Edit',   '?@template=item', 1)
     , ('tmplate_status',      'Edit',   '?@template=item', 1)
     , ('transceiver',         'Create', '?@template=item', 1)
     , ('uc_type',             'Edit',   '?@template=item', 1)
     , ('user',                'Create', '?@template=item', 1)
     , ('user_dynamic',        'Edit',   '?@template=item', 1)
     , ('valid',               'Edit',   '?@template=item', 1)
     , ('work_location',       'Edit',   '?@template=item', 1)
     , ( 'vacation_correction'
       , 'Edit'
       , '?@template=item'
       , utils.user_has_role (db._db, db._db.getuid (), 'HR-vacation')
       )
     )
   , [ ('abo',                 'View', 1,               ('',''))
     , ('abo_type',            'View', 1,               ('',''))
     , ('abo_price',           'View', 1,               ('',''))
     , ('address'
       , 'View'
       , 'person' not in db._db.classes
       , ('','')
       )
     , ('adr_type_cat',        'Edit', 1,               ('',''))
     , ('adr_type',            'Edit', 1,               ('',''))
     , ('alias',               'View', 1,               ('',''))
     , ('artefact',            'View', 1,               ('',''))
     , ('category',            'View', 1,               ('',''))
     , ('contact',             'View', 1,               ('',''))
     , ('cost_center',         'View', 1,               ('',''))
     , ('currency',            'View', 1,               ('',''))
     , ('customer_agreement',  'View', 1,               ('',''))
     , ('customer',            'View', 1,               ('',''))
     , ('cust_supp',           'View', 1,               ('',''))
     , ( 'daily_record'
       , 'View'
       , utils.user_has_role (db._db, db._db.getuid (), 'controlling', 'hr')
       , ('','')
       )
     , ('daily_record_freeze', 'View', 1,               ('',''))
     , ('device_group',        'View', 1,               ('',''))
     , ('device',              'View', 1,               ('',''))
     , ('discount_group',      'View', 1,               ('',''))
     , ('doc',                 'View', 1,               ('',''))
     , ('dyndns_protocol',     'View', 1,               ('',''))
     , ('dyndns',              'View', 1,               ('',''))
     , ('ext_tracker_state',   'View', 1,               ('',''))
     , ('group',               'View', 1,               ('',''))
     , ('invoice_group',       'View', 1,               ('',''))
     , ('invoice_template',    'View', 1,               ('',''))
     , ('invoice',             'View', 1,               ('',''))
     , ('invoice',             'View', 1, ('generate invoices','send'))
     , ('issue',               'View', 1,               ('',''))
     , ('it_issue',            'View', 1,               ('',''))
     , ('it_project',          'View', 1,               ('',''))
     , ('kpm',                 'View', 1,               ('',''))
     , ('leave_submission',    'View', 1,               ('',''))
     , ( 'leave_submission'
       , 'Edit'
       , utils.user_has_role
         (db._db, db._db.getuid (), 'HR-leave-approval', 'HR-vacation')
       , ('Leave approval','approve_hr')
       )
     , ( 'timesheet'
       , 'View'
       , utils.user_has_role
         (db._db, db._db.getuid (), 'User')
       , ('Timetable','index')
       )
     , ('legalclient',         'View', 1,               ('',''))
     , ('letter',              'View', 1,               ('',''))
     , ('logstyle',            'View', 1,               ('',''))
     , ('measurement',         'View', 1,               ('',''))
     , ('overtime_correction'
       , 'View'
       , utils.user_has_role (db._db, db._db.getuid (), 'HR', 'Controlling')
       , ('','')
       )
     , ('payment',             'View', 1,               ('',''))
     , ('person',              'View', 1,               ('',''))
     , ('prodcat',             'View', 1,               ('',''))
     , ('product',             'View', 1,               ('',''))
     , ('pr_supplier',         'View', 1,               ('',''))
     , ('pr_supplier_rating',  'View', 1,               ('',''))
     , ('public_holiday',      'View', 1,               ('',''))
     , ('purchase_request',    'View', 1,               ('',''))
     , ('purchase_type',       'View', 1,               ('',''))
     , ('qsl',                 'View', 1,               ('',''))
     , ('qso',                 'View', 1,               ('',''))
     , ('reference',           'View', 1,               ('',''))
     , ( 'sap_cc'
       , 'View'
       , not request.user.hasPermission ('Edit', 'sap_cc')
       , ('', '')
       )
     , ('sensor',              'View', 1,               ('',''))
     , ('summary_report',     'View', 1, ('Staff Report','staff'))
     , ('support',             'View', 1,               ('',''))
     , ('time_project',        'View', 1,               ('',''))
     , ('time_record',         'View', 1,               ('',''))
     , ('time_wp_group',       'View', 1,               ('',''))
     , ('time_wp',             'View', 1,               ('',''))
     , ('tmplate_status',      'View', 1,               ('',''))
     , ('tmplate',             'View', 1,               ('',''))
     , ('transceiver',         'View', 1,               ('',''))
     , ( 'transceiver'
       , 'View'
       , utils.user_has_role (db._db, db._db.getuid (), 'Admin')
       , ('Database Management','del')
       )
     , ('user_contact',      'Search', 1,               ('',''))
     , ('user_dynamic',      'Search', 1,               ('',''))
     , ('user',              'Search', 1,               ('',''))
     , ( 'user'
       , 'View'
       , db.user.roles.is_view_ok ()
       , ('roles','role')
       )
     , ( 'vacation_correction'
       , 'View'
       , utils.user_has_role (db._db, db._db.getuid (), 'HR-vacation')
       , ('','')
       )
     , ('vacation_report',     'View', 1,               ('',''))
     , ('valid',               'View', 1,               ('',''))
     ] + utils.summary_report_links (db._db)
   )
">
 <head>
  <title metal:define-slot="head_title">
   <span tal:replace="head_title"/>
  </title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8;">
  <link rel="stylesheet" type="text/css" href="@@file/style.css">
  <script tal:replace="structure request/base_javascript"></script>
  <script type="text/javascript"
          src="@@file/lfiles/js/jquery-1.12.4.min.js"></script>
  <script type="text/javascript"
            src="@@file/lfiles/js/formhandler.js"></script>
  <script type="text/javascript"
          src="@@file/lfiles/js/jquery.issuetracker.js"></script>
  <link rel="stylesheet" type="text/css" href="@@file/lfiles/libs/select2/4.0.7/css/select2.min.css">
  <script type="text/javascript"
          src="@@file/lfiles/libs/select2/4.0.7/js/select2.min.js"></script>
  <script type="text/javascript"
          src="@@file/lfiles/js/daily_record_advanced.js"></script>
  <tal:block metal:define-slot="add-js"></tal:block>
 </head>
 <body class="body">
  <table class="body" align="center" valign="middle"
   tal:condition="not:is_user">
   <tr>
<!-- login -->
    <td>
<form method="POST" name="login_form" tal:attributes="action request/base">
     <table class="form">
      <tr>
       <td colspan="2" align="center">
        <span i18n:translate="">Welcome:</span>
        <br>
        <tal:block tal:replace="config/TRACKER_NAME"/>
        <br>
        <font size="-2">
         <span i18n:translate="">
         Note: You definitely need <b>Cookies</b> and <b>JavaScript</b> enabled.
         </span>
        </font>
       </td>
      </tr>
      <tr>
       <th i18n:translate="">Login:</th>
       <td><input size="15" name="__login_name"></td>
      </tr>
      <tr>
       <th i18n:translate="">Password:</th>
       <td><input size="15" type="password" name="__login_password"></td>
      </tr>
      <tr>
       <th i18n:translate="">Remember me?:</th>
       <td><input type="checkbox" name="remember" id="remember"></td>
      </tr>
      <tr>
       <td colspan="2" align="center">
        <input type="submit" name="@action" value="Login">
       </td>
      </tr>
      <tr tal:condition="python:request.user.hasPermission
           ('Register', 'user')">
       <td colspan="2" align="center">
	<a href="user?@template=register"
           tal:condition="python:request.user.hasPermission
           ('Register', 'user')" i18n:translate="">Register</a>
       </td>
      </tr>
      <tr tal:condition="python:request.user.hasPermission
           ('Register', 'user')">
       <td colspan="2" align="center">
	<a href="user?@template=forgotten" i18n:translate="">
          Lost&nbsp;your&nbsp;login?</a>
       </td>
      </tr>
     </table>
     <script language="javascript">
     <!--
       document.login_form.__login_name.focus ();
       document.login_form.__login_name.select ();
     -->
     </script>
</form>
    </td>
   </tr>
  </table>

<!-- menubar -->
<tal:block metal:define-slot="menubar_slot">
<form name="menubar">
  <table bgcolor="#eeeeee" tal:condition="is_user">
   <tr>

    <!-- create new / query -->
    <tal:block metal:define-slot="create_or_query" />

    <!-- template specific menues -->
    <!-- time-tracking for current daily_record selection or current week -->
    <td class="sidebar">
     <span tal:condition="python:
      (   'user_dynamic' in db._db.classes
      and db._db.user_dynamic.find (user = request.user.id)
      )">
      <span class="classblock">
       <a i18n:translate=""
          tal:attributes="href python:utils.time_url (request, classname)">
        Time
       </a>
      </span>
      <span class="classblock"
       tal:define="dyn python: utils.get_user_dynamic
          (db._db, db._db.getuid (), utils.now ())"
       tal:condition="python:
            utils.get_vacation_correction (db._db, request.user.id)
            and dyn
            and db._db.org_location.get (dyn.org_location, 'do_leave_process')
            ">
       <a i18n:translate="" href="leave_submission?@template=edit">
        Leave
       </a>
      </span>
     </span>

     <!-- approval if user can approve records -->
     <span tal:condition="approval_for">
      <span class="classblock">
       <a i18n:translate="" tal:attributes="href python:
        [ 'daily_record?:template=approve&:sort=user&:filter=user&user=%s'
          % ','.join (approval_for.keys ())
        , str (request.indexargs_url (classname, {'@template':'approve'}))
        ][   classname == 'daily_record'
         and request.template not in ('approve','edit')
         ]">
        Approval
       </a>
      </span>
      <span class="classblock">
       <a i18n:translate="" href="leave_submission?@template=approve">
        Approve Leaves
       </a>
      </span>
     </span>

     <!-- custom classes with "New" Button -->
     <tal:block tal:repeat="c python:
                [('address', 'customer_group'), ('cust_supp', 'abo')]">
        <tal:block tal:condition="python:
          (   c [0] in db._db.classes
          and not c [1] in db._db.classes
          and request.user.hasPermission('View', c [0])
          )">
         <span class="classblock">
          <a tal:condition="python:request.user.hasPermission('View', c [0]) or
                                   request.user.hasPermission('Edit', c [0])"
             tal:attributes="href python:
                 '%s?%s' % (c [0], default_queries.get ((c [0], ''), ''))"
             tal:content="python:i18n.gettext (c [0])"/>
          <span tal:condition="python:
                request.user.hasPermission('Edit', c [0])">
             /
             <a tal:attributes="href python:'%s?:template=item' % c [0]">Neu</a>
          </span>
         </span>
        </tal:block>
     </tal:block>

     <!-- other custom classes with special template -->
     <tal:block tal:repeat="c python:[('invoice','send')]">
        <tal:block tal:condition="python:
          (   'invoice' in db._db.classes
          and  request.user.hasPermission('Edit', c [0])
          )">
         <span class="classblock">
          <a tal:condition="python:request.user.hasPermission('Edit', c [0])"
             tal:attributes=
              "href python:'%s?%s&@template=%s' %
                (c [0], default_queries.get ((c [0], ''), ''), c [1])"
             tal:content="python:i18n.gettext (c [0])">xyzzy</a>
         </span>
        </tal:block>
     </tal:block>

     <!-- Lielas links to sensor and measurement -->
     <tal:block tal:repeat="c python:
            [('sensor','index', ''),('measurement','index', ' (CSV)')]">
        <tal:block tal:condition="python:
          (   'measurement' in db._db.classes
          and  request.user.hasPermission('View', c [0])
          )">
         <span class="classblock" tal:define="
               a python:
                 ( '&@action=export_csv_lielas'
                 , '&:nosearch=1'
                 ) [c [0] == 'sensor']">
          <a tal:condition="python:request.user.hasPermission('View', c [0])"
             tal:attributes=
              "href python:'%s?%s&@template=%s%s' %
                (c [0], default_queries.get ((c [0], c [2]), ''), c [1], a)"
             tal:content="python:
               i18n.gettext (c [0]) + (c[2] and i18n.gettext (c [2]))"/>
         </span>
        </tal:block>
     </tal:block>

     <!-- user list -->
     <span class="classblock"
           tal:condition="python:
               'title' in db._db.user.properties
               and db.user.title.is_view_ok ()">
      <a tal:condition="python:request.user.hasPermission('View', 'user')
                            or request.user.hasPermission('Edit', 'user')"
         tal:attributes="href python: 'user?' + default_queries [('user','')]"
         i18n:translate="">
         User&nbsp;List
      </a>
     </span>

     <!-- phone list -->
     <span class="classblock"
           tal:condition="python:
           'user_contact' in db._db.classes
           and db.user_contact.is_view_ok ()">
      <a tal:condition="python:
              request.user.hasPermission('View','user_contact')
              or request.user.hasPermission('Edit','user_contact')"
         tal:attributes="href python:
           'user_contact?' + default_queries [('user_contact','grouped')]"
         i18n:translate="">
         Phone&nbsp;List
      </a>
     </span>

     <!-- User manual if existing -->
     <span class="classblock" tal:condition="python:utils.user_manual_ok (db)">
      <a i18n:translate="" tal:attributes="href python:utils.user_manual (db)">
      User Manual
      </a>
     </span>

     <!-- username -> link to own profile -->
     <span class="classblock" tal:condition="request/user/username/is_view_ok">
      <a tal:attributes="href string:user${request/user/id}"
         tal:content="string:${request/user/username}"></a>
     </span>

     <!-- logout -->
     <span class="classblock">
      <a tal:condition="python:request.user.username!='anonymous'"
         tal:attributes="href python:request.indexargs_href
         ('', {'@action':'logout'})">Logout</a>
      <a tal:condition="python:request.user.username=='anonymous'"
         tal:attributes="href python:request.indexargs_href
         ('', {':login':'1'})">Login</a>
     </span>
   </tr>
   <tal:block metal:define-slot="menu_slot"/>
  </table>
</form>
</tal:block>

<!-- body_title -->
  <tal:block tal:condition="is_user">
   <h3>
    <span metal:define-slot="body_title">
     <span tal:replace="head_title"/>
    </span>
   </h3>
  </tal:block>

<!-- errors --->
  <p tal:condition = "options/error_message | nothing"
     class         = "error-message"
     tal:repeat    = "m options/error_message"
     tal:content   = "structure m">error</p>
  <p tal:condition = "options/ok_message | nothing"
     class         = "ok-message"
     tal:repeat    = "m options/ok_message"
     tal:content   = "structure m">error</p>

<!-- page content -->
  <tal:block tal:condition="is_user">
   <span class="content" metal:define-slot="content"></span>
  </tal:block>

<!-- debug output -->
 <pre tal:condition="request/form/debug | nothing" tal:content="request"></pre>
 </body>
</html>
</tal:block>


<!-- Macro to display selector for new item in menu -->
<td metal:define-macro="create_new" class="sidebar" nowrap>
 <span class="classblock">
  <select name="create_new"
          onChange="javascript:document.location=document.forms['menubar'].elements['create_new'].options[document.forms['menubar'].elements['create_new'].options.selectedIndex].value; ">
   <option value="" i18n:translate="">-- Create --</option>
   <tal:block tal:repeat="k python:
    sorted ( [k for k in klasses if k [0] in db._db.classes]
           , key = lambda x, y = i18n.gettext : y (x [0]).lower ()
           )">
    <option tal:condition="python:request.user.hasPermission(k [1], k [0])
                                  and k [3]"
            tal:attributes="value python:k[0] + k[2]"
            tal:content="python:i18n.gettext (k[0])" />
   </tal:block>
  </select>
 </span>
</td>

<!-- Macro to display query selector in menu -->
<td metal:define-macro="select_query" class="sidebar" nowrap>
 <span class="classblock">
  <select name="query"
          onChange="javascript:document.location=document.forms['menubar'].elements['query'].options[document.forms['menubar'].elements['query'].options.selectedIndex].value; ">
   <option value="" i18n:translate="">-- View / Query --
   </option>
   <option tal:condition="db/query/is_edit_ok"
    value="query?@template=edit" i18n:translate="">Manage Queries
   </option>
   <tal:block
    tal:repeat="k python: sorted
        ( [k for k in klasses if k [0] in db._db.classes]
        , key = lambda x, y = i18n.gettext : y (x [3][0] or x [0]).lower ()
        )">
     <tal:block tal:define=
       " name   python: i18n.gettext (k [3][0] or k [0])
       ; klass  python: k [0]
       ; perm   python: k [1]
       ; ok     python: k [2]
       ; tplate python: ('@template=%s&' % k [3][1], '') [not k [3][1]]
       ; qkey   python: k [3][1] or 'index'
       " tal:condition="python:
          (request.user.hasPermission (perm, klass) and ok)">
         <option tal:attributes="value python: '%s?%s%s' %
          ( klass
          , tplate
          , default_queries.get ((klass, k[3][1]), default_query)
          )"
          tal:content="name"/>
         <option tal:define="
            queries python:db.query.filter
             (filterspec = dict
              (private_for = None, klass = klass, tmplate = qkey)
             , sort=('+', 'name')
             )"
          tal:repeat="q queries"
          tal:attributes="
           value string:${klass}?@queryname=${q/name}&queryid=${q/id}&${tplate}${q/url}"
          tal:content="structure string:&nbsp;&nbsp;${q/name}"
         >  Global Queries</option>
         <tal:block tal:condition="request/user/queries">
          <option tal:define="
             queries python:[q for q in db.query.filter
              (filterspec = dict
               ( private_for = request.user.id
               , klass       = klass
               , id          = [q.id for q in request.user.queries]
               , tmplate     = qkey
               )
              , sort=('+', 'name')
              ) if q.klass == klass]"
           tal:repeat="q queries"
           tal:attributes="
            value
            string:${klass}?@queryname=${q/name}&queryid=${q/id}&${tplate}${q/url}"
           tal:content="structure string:&nbsp;&nbsp;&nbsp;&nbsp;${q/name}"
          >    Private Queries</option>
         </tal:block>
     </tal:block>
   </tal:block>
  </select>
 </span>
</td>

<!-- Macro to display selector for new class and query selector in menu
     This creates the menu items used in Tracker classes as default
-->
<tal:block metal:define-macro="create_or_query_new_tracker_item">
 <tal:block tal:define="menu python: menu_time">
  <tal:block tal:define="klasses python: menu [0]">
   <td metal:use-macro="templates/page/macros/create_new" />
  </tal:block>

  <tal:block tal:define="klasses python: menu [1]">
   <td metal:use-macro="templates/page/macros/select_query" />
  </tal:block>
 </tal:block>
</tal:block>

<tal:block metal:define-macro="responsible">
   <tr tal:condition="has_resp">
    <th tal:attributes="class responsible_required | default"
     tal:content="structure python:utils.fieldname(classname, 'responsible')">
    </th>
    <td colspan="3">
     <tal:block tal:define=
        "name      string:responsible;
         form      string:itemSynopsis;
         dont_care python:i18n.gettext ('''- don't care -''');
         selected python:context.responsible and context.responsible.id or 0">
      <tal:block metal:use-macro="templates/userlist/macros/user"/>
     </tal:block>
    </td>
   </tr>
</tal:block>

<!-- the following macro is used for all pages which display a
     class that needs some more formatting -->

<tal:block metal:define-macro="formatted_class">
 <span tal:condition="python:not (context.is_view_ok() or context.is_edit_ok())">
 You are not allowed to view this page.
 </span>
 <form method="POST"
       onSubmit="return submit_once()"
       enctype="multipart/form-data"
       tal:attributes="action context/designator; name formname"
       tal:condition="python:context.is_view_ok() or context.is_edit_ok()">

  <input type="hidden" name="@template" tal:attributes="value form_template">

  <table tal:attributes="class python:form_class">
   <tr tal:condition="use_labelprop">
    <th class="required"
     tal:content="structure python:utils.fieldname(classname, labelprop)"/>
    <input tal:condition="python:not context [labelprop].is_edit_ok ()"
     type="hidden" tal:attributes=
      " name  labelprop
      ; value python:context [labelprop]
      ">
    <td colspan="3"
        tal:content="structure python:context [labelprop].field (size=60)"/>
   </tr>
   <tal:block metal:use-macro="templates/page/macros/responsible"/>
   <tal:block metal:define-slot="formatted_class_content"/>

   <tr tal:condition="python:has_nosy and context.nosy.is_view_ok ()">
    <th tal:content="structure python:utils.fieldname(classname, 'nosy')"/>
    <td colspan="3">
     <span tal:replace="structure python:context.nosy.field(70)"/>
     <span tal:condition="context/is_edit_ok"
           tal:replace="structure python:utils.user_classhelp
             ( db
             , property='nosy'
             , inputtype='checkbox'
             , user_status = nosy_stati
             )"/><br>
    </td>
   </tr>
   <tal:block metal:define-slot="below-nosy" />

   <tr metal:use-macro="templates/page/macros/message_box"/>
   <tr metal:define-slot="after-message-box" />

   <tr tal:condition="python:
       has_files and want_files and context.files.is_edit_ok ()">
    <th tal:content="structure python:utils.fieldname(classname, 'files')"/>
    <td colspan="3">
      <input type="file" name="@file" size="40" multiple="multiple"/>
      <tal:block tal:condition="python:
           utils.Size_Limit (db, 'LIMIT_FILE_SIZE')">
        &nbsp;Max:&nbsp;
        <span tal:content="python:
              utils.Size_Limit (db, 'LIMIT_FILE_SIZE')"/>
      </tal:block>
    </td>
   </tr>

   <tr>
    <th></th>
    <td colspan="3">
     <tal:block metal:define-slot="button_slot"
      tal:condition="context/is_edit_ok">
         <tal:block tal:replace="structure context/submit"/>
     </tal:block>
     <tal:block metal:define-slot="additional_button"/>
     <input tal:condition="context/id"
            type="button" value="Show History"
            i18n:attributes="value"
            tal:attributes="onClick string:javascript:help_window('${context/designator}?@template=history','600','300')">
     <tal:block metal:define-slot="right_of_show_history"/>
    </td>
   </tr>
   <tr metal:define-slot="formatted_class_listentry"/>
   <tr tal:condition="has_invoices">
    <th style="text-align:left" class="required"
     tal:content="structure python:utils.fieldname(classname, 'invoices')"
     tal:condition="context/invoices" />
   </tr>
   <tal:block tal:repeat="inv context/invoices/reverse"
    tal:condition="has_invoices">
    <tr>
     <th tal:content="structure python:
      utils.fieldname ('invoice','invoice_no')"/>
     <td tal:content="structure python:''.join
         (( utils.ExtProperty
            (utils, inv.invoice_no, item = inv).as_listentry ()
         ,
         ))"/>
     <th tal:content="structure python:
      utils.fieldname ('invoice', 'period', 'period_start')"/>
     <td tal:content="structure python:''.join
         (( utils.ExtProperty
            (utils, inv.period_start, item = inv).as_listentry ()
         , '-'
         ,  utils.ExtProperty
            (utils, inv.period_end,   item = inv).as_listentry ()
         ))"/>
    </tr>
   </tal:block>
   <tr tal:condition="python:has_letters and context.letters">
    <th style="text-align:left" class="required"
     tal:content="structure python:utils.fieldname (classname, 'letters')"/>
   </tr>
   <tal:block tal:repeat="ltr context/letters/reverse"
    tal:condition="has_letters">
    <tr>
     <th tal:content="structure python:utils.fieldname ('letter','period')"/>
     <td tal:content="structure python:''.join
         (( utils.ExtProperty
            (utils, ltr.date, item = ltr, is_labelprop = 1).as_listentry ()
          , '&nbsp;'
          , '--'
          , '&nbsp;'
          , utils.letter_link (request, ltr.id)
         ))"/>
     <th tal:content="structure python:utils.fieldname ('letter', 'subject')"/>
     <td tal:content="structure python:''.join
         ((  utils.ExtProperty
            (utils, ltr.subject, item = ltr).as_listentry ()
          ,
         ))"/>
    </tr>
   </tal:block>
  </table>
  <p tal:condition="python:context.id and show_creation" i18n:translate="">
   Created on
   <b i18n:name="creation" tal:content="python:context.creation.pretty
      ('%Y-%m-%d %H:%M:%S')"/> by
   <b i18n:name="creator"  tal:content="context/creator"/>, last changed
   <b i18n:name="activity" tal:content="python:context.activity.pretty
      ('%Y-%m-%d %H:%M:%S')"/> by
   <b i18n:name="actor"    tal:content="context/actor"/>.
  </p>
  <input type="hidden" name="@required"
         tal:attributes="value required_attributes | labelprop">

 </form>

 <tal:block metal:define-slot="before_messages"/>

 <table metal:use-macro="templates/page/macros/note_required" />
 <table metal:use-macro="templates/page/macros/message_display" />
 <table class="files" tal:condition="python:
        has_files and context.files and context.files.is_view_ok ()">
  <tr>
   <th colspan="3" class="header">Files</th>
  </tr>
  <tr>
   <td colspan="3">
    <tal:block metal:use-macro="templates/page/macros/file_list"/>
   </td>
  </tr>
 </table>
</tal:block>

<tal:block metal:define-macro="send_to_customer">
     <input type="button" tal:condition="context/id"
            value="Send to Customer" i18n:attributes="value"
            tal:attributes="onClick python:utils.send_to_customer_js ()"/>
</tal:block>

<tal:block metal:define-macro="copy_button">
     <input type="button" tal:condition="context/id"
            value="Create similar" i18n:attributes="value"
            tal:attributes="onClick python:utils.copy_js ()"/>
     <a style="display:none" id="copyme" target="_blank"
        tal:attributes="href python:utils.copy_url (context)">X</a>
</tal:block>

<tal:block metal:define-macro="spam_button">
     <input type="button" tal:condition="context/id"
            value="Mark as Spam" i18n:attributes="value"
            onClick="mark_spam_js();"/>
     <script tal:content="structure python:utils.mark_spam_js(db)">
     </script>
     <a style="display:none" id="copyme" target="_blank"
        tal:attributes="href python:utils.copy_url (context)">X</a>
</tal:block>

<tal:block metal:define-macro="message_box">
  <tr tal:condition="python:context.is_edit_ok () and has_msgs">
   <th tal:content="structure python:utils.fieldname(classname,'msg')" />
   <td colspan="3">
    <textarea tal:content="request/form/@note/value | default"
              tal:attributes="rows msg_box_height"
              name="@note"
              cols="80"/>
   </td>
  </tr>
</tal:block>

<tal:block metal:define-macro="note_required">
 <table class="form" tal:condition="python:
        not context.id and context.is_edit_ok ()">
 <tr>
  <td i18n:translate="">Note:&nbsp;</td>
  <th class="required" i18n:translate="">highlighted</th>
  <td i18n:translate="">&nbsp;fields are required.</td>
 </tr>
 </table>
</tal:block>

<tal:block metal:define-macro="message_display">
 <table class="messages" tal:condition="python:
  has_msgs and context.messages and context.is_view_ok ()">
  <tr>
   <th class="header" tal:attributes="colspan python:3+may_remove_msgs"
       tal:content="structure python:
           utils.fieldname (classname, 'messages')"/>
  </tr>
  <tal:block tal:repeat="msg context/messages/reverse">
   <tr>
    <th><a tal:attributes=
           "href string:msg${msg/id};
            class python: ['messages','external']
                          [bool(utils.has_x_roundup_header (db, msg))]
           "
           tal:content="string:msg${msg/id}"></a>
    </th>
    <th>
     <tal:block i18n:translate="">Author:</tal:block>
     <a tal:attributes="href string:user${msg/author/id}"
        tal:content="msg/author"/>
    </th>
    <th>
     <tal:block i18n:translate="">Date:</tal:block>
     <tal:block tal:content="msg/date"/>
    </th>
    <th tal:condition="may_remove_msgs">
     <form style="padding:0" method="POST" tal:condition="context/is_edit_ok"
           tal:attributes="action string:issue${context/id}">
      <input type="hidden" name="@remove@messages"
             tal:attributes="value msg/id">
      <input type="hidden" name="@action" value="edit">
      <input type="submit" value="remove">
     </form>
    </th>
   </tr>
   <tr>
    <td tal:attributes="colspan python:3+may_remove_msgs" class="content">
     <div class="prewrap"
          tal:content="structure python:msg.content.hyperlinked ()"/>
    </td>
   </tr>
   <tal:block tal:define="files python:msg.files"
              tal:condition="python:
              files and not request.user.hide_message_files">
    <tal:block metal:use-macro="templates/page/macros/parametric_file_list"/>
   </tal:block>
  </tal:block>
 </table>
</tal:block>

<!-- list links to a group of items -->
<!-- needs items and klassname set up -->
<!-- klassname should be the name of the klass, is used for the style class -->
<!-- each item should be a HTMLItem with the following properties: -->
<!-- status/name, status/abbreviation, title, responsible -->
<!-- status should map a ${klassname}_${item/status}_${postfix} a.href class in style.css -->
<!--   where postfix will be "${item/test_ok|nothing}" -->
<tal:block metal:define-macro="task_list">
 <tal:block tal:repeat="item items"
            tal:define="postfix item/test_ok|python:''">
  <a tal:attributes="href item/designator;
                     class string:${klassname}_${item/status}_${postfix}"
     tal:content="structure string:<code>${item/designator} (${item/status/abbreviation}, ${item/responsible/nickname}):</code> ${item/title}"></a><br>
 </tal:block>
</tal:block>

<tal:block metal:define-macro="simple_list">
 <tal:block tal:repeat="item items">
  <a tal:attributes="href item/designator;
                     class string:${klassname}_${item/status}"
     tal:content="structure string:<code>${item/designator} (${item/status}, ${item/responsible/nickname}):</code> ${item/title}"></a><br>
 </tal:block>
</tal:block>

<tal:block metal:define-macro="file_list">
 <tal:block tal:define="files context/files">
  <table class="files" tal:condition="files">
   <tal:block metal:use-macro="templates/page/macros/parametric_file_list"/>
  </table>
 </tal:block>
</tal:block>

<!-- generic list of files with given parameter files -->
<tal:block metal:define-macro="parametric_file_list">
 <tr>
  <th class="file">File name</th>
  <th class="file">Uploaded</th>
  <th class="file">Type</th>
 </tr>
 <tr tal:repeat="file files">
  <td class="file">
   <a tal:attributes="href file/download_url"
      tal:content="file/name">dld link</a>
  </td>
  <td class="file">
   <span tal:content="file/creator">creator's name</span>,
   <span tal:content="file/creation">creation date</span>
  </td>
  <td tal:content="file/type" class="file"/>
 </tr>
</tal:block>

<!-- the following lists a nice list of files plus file upload form -->
<tal:block metal:define-macro="formatted_class_files">
 <tal:block metal:use-macro="templates/page/macros/file_list"/>
 <input type="file" name="@file" size="40">
</tal:block>

<!-- the following is used to have those nifty index/search form on one page -->
<!-- the caller needs to define a list of tuples for the properties: -->
<!--  props = (("<name to display>", "<designator>"), ...) -->

<tal:block metal:define-macro="search_nav">
<!-- previous / next links -->
   <tr>
    <th tal:attributes="colspan python:len(request.columns)">
     <table width="100%">
      <tr class="navigation">
       <th class="left">
        <a tal:define="prev batch/previous;
                       d python: utils.indexargs_dict (prev, request.form);"
           tal:condition="prev" i18n:translate="" tal:attributes="href python:
               str (request.indexargs_href (request.classname, d))">
           &lt;&lt;&nbsp;previous
        </a>
       </th>
       <th tal:condition="batch/sequence_length">
        <nobr i18n:translate="">
            showing <span tal:replace="batch/start" i18n:name="start"/>
            - <span tal:replace="python:batch.start + batch.length -1"
                    i18n:name="end"/>
            of <span tal:replace="batch/sequence_length" i18n:name="length"/>
            in total
        </nobr>
       </th>
       <th tal:condition="not:batch/sequence_length">
        <nobr i18n:translate="">
        Sorry, no results found
        </nobr>
       </th>
       <th class="right">
        <a tal:define="next batch/next;
                       d python: utils.indexargs_dict (next, request.form);"
           tal:condition="next" i18n:translate="" tal:attributes="href python:
               str (request.indexargs_href (request.classname, d))">
           next&nbsp;&gt;&gt;
        </a>
       </th>
      </tr>
     </table>
    </th>
   </tr>
</tal:block>

<!--
 the next two search_results and simple_search_form needs the following
 variables set up as follows:
 props: a tuple (or list) of ExtProperty objects. See extensions/extproperty.py
-->

<!-- display the search results -->
<tal:block metal:define-macro="search_results">
 <tal:block tal:condition="not:quiet">
  <tal:block tal:condition="not:context/is_view_ok">
   You are not allowed to view this page.
  </tal:block>

  <tal:block tal:define="batch request/batch"
             tal:condition="context/is_view_ok">
   <table class="list" border=1>
    <tr>
     <!-- list all properties we want to see -->
     <tal:block tal:repeat="prop props">
      <th tal:condition="python:request.show[prop.searchname]"
          tal:content="python:prop.i18nlabel"/>
     </tal:block>
    </tr>
    <tal:block metal:use-macro="templates/page/macros/search_nav"/>
    <!-- items found -->
    <tal:block tal:repeat="i batch">
     <tr tal:condition="python:
       request.group and batch.propchanged(*[g[1] for g in request.group])">
      <th tal:attributes="colspan python:len(request.columns)" class="group">
       <tal:block tal:repeat="gr request/group">
        <tal:block tal:content="python:i[gr[1]]"/>
       </tal:block>
      </th>
     </tr>
     <tr tal:attributes="class python:['normal', 'alt'][repeat['i'].index%2]">
      <!-- all the properties: label property and id will be made a link -->
      <!-- filter out only the properties the user wants to see -->
      <tal:block tal:repeat="prop props">
       <td tal:condition="python:request.show [prop.searchname]"
           tal:content="structure python:prop.as_listentry (i)"
           tal:attributes="class python:prop.get_cssclass(i)">
       </td>
      </tal:block>
     </tr>
    </tal:block> <!-- repeat i batch -->
   </table>
  </tal:block>
 </tal:block>
</tal:block>

<tal:block metal:define-macro="simple_search_form">
 <tal:block tal:define=
     " multi_props    python: [p for p in props if p.multiselect
                               and utils.may_search
                                (db._db, uid, classname, p.searchname)
                              ]
     ; sort_props     python: [p for p in props if p.sortable
                               and utils.may_search
                                (db._db, uid, classname, p.searchname)
                              ]
     ; nomulti_props  python: [p for p in props
                               if (not p.multiselect and p.searchable)
                               and utils.may_search
                                (db._db, uid, classname, p.searchname)
                              ]
     ; csv_action     python: 'export_csv_names'
     ; csv_link       python:request.indexargs_url
            (classname, {'@action':csv_action})
     ; do_fulltext    python: not terse
     ; do_pagesize    python: True
     ; do_query       python: True
     ; props          python: [p for p in props if p.displayable]
     ">
  <tal:block metal:use-macro="templates/page/macros/search_form"/>
 </tal:block>
</tal:block>

<!-- needs terse, props, multi_props, sort_props, nomulti_props, csv_link -->
<tal:block metal:define-macro="search_form">
 <!-- query specification form -->
 <form method="GET" name="query"
  tal:attributes="action request/classname; class queryform_class">
  <tal:block metal:define-slot="search_variables"/>
  <input type="hidden" name=":action" value="searchwithtemplate">
  <input type="hidden" name=":startwith"
   tal:attributes="value request/startwith">
  <input type="hidden" name=":template"
   tal:attributes="value python:request.template or 'index'">
  <table border="0" class="searchform">
   <tr>
    <th i18n:translate="" colspan="5" class="main">
     <div tal:condition="python:queryform_class"></div>
     <span i18n:translate="">Query</span>
     <span tal:replace="head_title" i18n:name="title"/>
    </th>
   </tr>

   <tr tal:condition="not:terse">
    <td tal:condition="do_pagesize" colspan="2">
     <span i18n:translate="">View</span>
     <input type="text" size="4" name=":pagesize"
            tal:attributes="value request/pagesize">
     <span i18n:translate="">items per page</span>
    </td>
    <td/>
    <td style="text-align:right;" colspan="2" tal:condition="csv_link">
     <a tal:attributes="href csv_link" i18n:translate="">Download as CSV</a>
    </td>
   </tr>
   <input type="hidden" tal:condition="terse" name=":pagesize"
          tal:attributes="value request/pagesize">
   <tal:block tal:repeat="onum python:range(n_sort)"
    tal:condition="python:sort_props">
    <tal:block tal:define=
        "skey python:(len(request.sort) >onum or '') and request.sort [onum]
        ;gkey python:(len(request.group)>onum or '') and request.group[onum]
        ">
     <tal:block tal:condition="terse">
      <input type="hidden" tal:attributes=
             " name python:':sort%d'%onum
             ; value python:''.join ([k,''][k=='+'] for k in skey)
             ">
      <input type="hidden" tal:attributes=
             " name python:':group%d'%onum
             ; value python:''.join ([k,''][k=='+'] for k in gkey)
             ">
     </tal:block>
     <tr tal:condition="not:terse">
      <td nowrap>
       <tal:block tal:condition="not:onum" i18n:translate="">
           Sort on:
       </tal:block>
      </td>
      <td nowrap>
       <select tal:attributes="name python:':sort%d'%onum"
        onChange="this.form.elements[':startwith'].value='0'">
        <option value="" i18n:translate="">- nothing -</option>
        <option tal:repeat="prop sort_props"
         tal:attributes= "selected python:skey and prop.searchname==skey[1];
                          value    python:prop.searchname"
         tal:content="python:prop.i18nlabel"/>
       </select>
       <span i18n:translate="">Descending:</span>
       <input type="checkbox"
        tal:attributes="name python:':sortdir%d'%onum
                       ;checked python:skey and skey[0] == '-'
                       "
        onChange="this.form.elements[':startwith'].value='0'"/>
      </td>
      <td nowrap>&nbsp;</td>
      <td nowrap>
       <tal:block tal:condition="not:onum" i18n:translate="">
           Group on:
       </tal:block>
      </td>
      <td nowrap>
       <select tal:attributes="name python:':group%d'%onum"
        onChange="this.form.elements[':startwith'].value='0'">
        <option value="" i18n:translate="">- nothing -</option>
        <option tal:repeat="prop sort_props"
         tal:attributes= "selected python:gkey and prop.searchname==gkey[1];
                          value    python:prop.searchname"
         tal:content="python:prop.i18nlabel"/>
       </select>
       <span i18n:translate="">Descending:</span>
       <input type="checkbox"
        tal:attributes="name python:':groupdir%d'%onum
                       ;checked python:gkey and gkey[0] == '-'
                       "
        onChange="this.form.elements[':startwith'].value='0'"/>
      </td>
     </tr>
    </tal:block>
   </tal:block>
   <tr>
    <td colspan="5">
     <table border="0" bgcolor="#e0c0c0" align="left" class="searchform"
      tal:condition="python:props and not terse">
      <tr>
       <th style="text-align:left;" tal:content="structure python:
         utils.fieldname (classname, 'VIEW', endswith=':', csscls='header')"/>
      </tr>
      <tr>
       <!-- View -->
       <td style="text-align:center;">
        <select multiple name=":columns" size="7">
         <option tal:repeat="prop props"
                 tal:attributes="selected python:request.show[prop.searchname];
                                 value    python:prop.searchname"
                 tal:content="python:prop.i18nlabel"/>
        </select>
       </td>
      </tr>
     </table>
     <input tal:condition="terse" type="hidden" name=":columns"
            tal:attributes="value python:','.join(request.show.keys)">
     <tal:block tal:repeat="prop multi_props">
      <input tal:condition="python:terse and not prop.terse"
             type="hidden" tal:attributes=
             " name  python:prop.searchname
             ; value python:
                     ','.join(request.filterspec.get(prop.searchname) or [])
             ">
      <table border="0" bgcolor="#e0c0c0" align="left" class="searchform"
             tal:condition="python:not terse or prop.terse">
       <tr>
        <th style="text-align:left;"
         tal:content="structure python:prop.colonlabel()"/>
       </tr>
       <tr>
        <td style="text-align:center;">
         <tal:block tal:condition="python:
          prop.lnkcls.classname == 'user' and prop.searchname != 'nosy'"
          tal:define=
           "size      string:7;
            name      python:prop.searchname;
            form      string:query;
            dont_care python:i18n.gettext ('''- don't care -''');
            selected  python:
             str(request.filterspec.get(prop.searchname) or [''])[1:-1]
           ">
          <tal:block metal:use-macro="templates/userlist/macros/user_multi_read"/>
         </tal:block>
         <tal:block tal:condition="python:prop.searchname == 'nosy'"
          tal:define=
           "size      string:7;
            name      python:prop.searchname;
            form      string:query;
            dont_care python:i18n.gettext ('''- don't care -''');
            selected  python:
             str(request.filterspec.get(prop.searchname) or [''])[1:-1]
           ">
          <tal:block metal:use-macro="templates/userlist/macros/nosy_multi"/>
         </tal:block>
         <tal:block tal:condition="python:prop.lnkcls.classname != 'user'">
          <select multiple
                  size="7"
                  tal:attributes="name python:prop.searchname"
                  tal:define="form_vals
                    python:request.filterspec.get(prop.searchname) or []">
           <option value="" i18n:translate="" tal:attributes=
            "selected not:form_vals">- don't care -</option>
           <option value="-1" i18n:translate=""
            tal:condition="python: not prop.multi_selonly
                                   and not prop.leafprop.required"
            tal:attributes="selected python:'-1' in form_vals"
           >- not selected -</option>
           <option
            tal:repeat="s python: db[prop.lnkcls.classname].filter
                ( filterspec = prop.filter
                , group      = [('+', prop.lnkcls.orderprop ())]
                )"
            tal:attributes=
                "value    s/id;
                 selected python:s.id in form_vals"
            tal:content="python:
                '%s' % s[prop.propname]
              + ['',' '][bool (prop.multi_add)]
              + ' '.join ('%s=%s' % (p, s[p]) for p in prop.multi_add)
              ">
           </option>
          </select>
         </tal:block>
        </td>
       </tr>
      </table>
     </tal:block>
    </td>
   </tr>

   <tr>
    <td colspan="5">
     <table border="0" bgcolor="#e0c0c0">
      <!-- fill in text entry fields -->
      <tal:block tal:repeat="prop nomulti_props">
       <input tal:condition="python:terse and not prop.terse"
              type="hidden" tal:attributes=
              " name  python:prop.searchname
              ; value python:
                      ','.join(request.filterspec.get(prop.searchname) or [])
              ">
       <tr tal:condition="python:not terse or prop.terse">
        <th style="text-align:right;"
            tal:content="structure python:prop.colonlabel()"/>
        <td tal:define="prps python:
            [('description', 'status', 'responsible'), ()]
            [prop.lnkcls and prop.lnkcls.classname == 'user' or 0]">
         <tal:block tal:replace="structure python:prop.search_input (request)"/>
         <span tal:condition="python:prop.do_classhelp"
           tal:replace="structure python:db[prop.lnkcls.classname].classhelp
            ( properties=prop.classhelp_properties (*prps)
            , property=prop.searchname
            , form='query'
            , pagesize=5000
            , width='800'
            , filter=prop.help_filter
            , sort=prop.help_sort
            )"/>
        </td>
       </tr>
      </tal:block>
      <tr tal:condition="do_fulltext">
       <th style="text-align:right;" i18n:translate="">Search full text:</th>
       <td>
        <input type="text" size="40" name=":search_text"
         onChange="this.form.elements[':startwith'].value='0'"
         tal:attributes="value request/form/:search_text/value | nothing">
        <span i18n:translate="">(Searches also in messages)</span>
       </td>
      </tr>
      <!-- submit button -->
      <tr>
       <th/>
       <td>
        <input type="submit" i18n:attributes="value" value="Update view"
         onClick="document.forms ['query'].elements ['@queryname'].value = '';
                  document.forms ['query'].elements ['new_query'].value = '';
                  document.forms ['query'].elements ['queryid'].value = '';"
         tal:condition="not:terse">
        <input type="submit" i18n:attributes="value" value="Find"
         onClick="document.forms ['query'].elements ['@queryname'].value = '';
                  document.forms ['query'].elements ['new_query'].value = '';
                  document.forms ['query'].elements ['queryid'].value = '';"
         tal:condition="terse">
        <input type="submit" i18n:attributes="value" value="Show as CSV"
         tal:attributes = "onClick python:
         '\x3b'.join
          ('document.forms [\x22query\x22].elements '
           '[\x22%s\x22].value = \x22%s\x22'
          % k for k in
            ( ('@queryname', '')
            , ('new_query', '')
            , ('queryid', '')
            , (':action', csv_action)
            , ('@action', csv_action)
            )
          )" tal:condition="csv_action">
       </td>
      </tr>
      <tr tal:define="
        queryid   request/form/queryid/value | nothing;
        new_query request/form/new_query/value | nothing;
        u_q       python:sorted ([q.id for q in request.user.queries]);
        " tal:condition="python: not terse and do_query">
       <th style="text-align:right;" i18n:translate="">This query's name:</th>
       <td tal:define="queryid python:
           new_query and (u_q and u_q.pop()) or queryid">
        <input type="hidden" name="queryid"
               tal:attributes="value queryid | nothing">
         <span tal:condition="python:
               queryid and queryid in request.user.queries">
          <input type="hidden" name="@queryname">
          <input type="hidden" name="@old-queryname">
          <input type="text"
                name="_queryname"
                tal:attributes="value request/form/@queryname/value | default">
          <input type="submit" i18n:attributes="value"
           value="Update view & store this query"
           onClick="document.forms ['query'].elements ['@queryname'].value =
                    document.forms ['query'].elements ['_queryname'].value;
                    document.forms ['query'].elements ['@old-queryname'].value =
                    document.forms ['query'].elements ['_queryname'].value;
                    ">
          <span i18n:translate="">
            (If you change the name, you create a new query!!!)
          </span>
         </span>
         <span tal:condition="python:
               not queryid or queryid not in request.user.queries">
          <input type="text" name="@queryname" onChange=
            "document.forms ['query'].elements ['new_query'].value = '1';">
          <input type="hidden" name="new_query" value="">
          <input type="submit" i18n:attributes="value"
                 value="Update view & store NEW query">
         </span>
       </td>
      </tr>
     </table>
    </td>
   </tr>
  </table>
 </form>
</tal:block>

<!-- needed vars: property: Multilink to address, button_text -->
<tal:block metal:define-macro="address_list">
 <tr>
  <th tal:content="structure python:utils.fieldname (classname, property)"/>
  <td colspan="3">
   <table class="form" border="0"
          style="border-spacing:0px;padding-top:0px;padding-left:0px">
    <tr>
     <th style="text-align:left;padding-top:0px">
      <span tal:content="structure python:utils.fieldname
         ('address', 'firstname')"/>
      /
      <span tal:content="structure python:utils.fieldname
         ('address', 'lastname')"/>
      /
      <span tal:content="structure python:utils.fieldname
         ('address', 'function')"/>
     <th style="text-align:left;padding-top:0px"
         tal:condition="context/is_edit_ok" i18n:translate=""
         style="padding-top:0px">
         remove
     </th>
    </tr>
    <tr tal:repeat="ca python:sorted
        ( context [property]
        , key = lambda x : (x.firstname, x.lastname, x.function)
        )">
     <td>
      <span>
       <a i18n:translate="" tal:attributes="href python:
          'address%s' % ca.id">
        <span nowrap
         tal:content="python: ' '.join
          (( ca.firstname.plain ()
          ,  ca.lastname.plain ()
          ))"/>
        <span nowrap
         tal:content="python: ' '.join
          (ca.function.plain ().split ('\n')[:1])"/>
       </a>
      </span>
     </td>
     <td tal:condition="context/is_edit_ok">
      <input type="checkbox" tal:attributes="
                 value ca/id;
                 name  string:@remove@${property};">
     </td>
    </tr>
    <tr>
     <td colspan="2">
      <span>
       <input type="text" size="6" tal:attributes="
        onchange string:document.forms.itemSynopsis ['@link@${property}'].value
          = 'address' + document.forms.itemSynopsis.a_${property}.value;
        name string:a_${property}">
       <input type="hidden" tal:attributes="name string:@link@${property}">
       <input tal:condition="context/shipping_address"
         type="button" tal:attributes=
          "onClick python:'javascript:document.location = '
           '\'%s?@attr=%s&@frm=shipping_address&@action=create_new_address\''
           % (context.designator (), property)
          ; value python:utils.adress_button (db, 'shipping_address', property)
          ">
      </span>
     </td>
     <td>
       <input tal:condition="context/invoice_address"
         type="button" tal:attributes=
          "onClick python:'javascript:document.location = '
           '\'%s?@attr=%s&@frm=invoice_address&@action=create_new_address\''
           % (context.designator (), property)
          ; value python:utils.adress_button (db, 'invoice_address', property)
          ">
     </td>
    </tr>
   </table>
  </td>
 </tr>
</tal:block>

<tal:block metal:define-macro="innerperslist">
    <tr tal:condition="cond">
     <td colspan="3">
      <a i18n:translate="" tal:attributes="href python:
         'person?@template=item&' + '&'.join
          ([ '%s=%s' % (i [0], utils.urlquote (str (i [1]))) for i in
            [ ('person_type', ptype)
            , ('cust_supp',   context.id)
            , ('function',    context.name)
            ]
           ]
          )">
        New <span tal:replace="Name" i18n:name="Name"/>
      </a>
     </td>
    </tr>
    <tr tal:condition="persons">
     <th style="text-align:left;padding-top:0px">
      <span tal:content="structure python:utils.fieldname
         ('person', 'firstname')"/>
      /
      <span tal:content="structure python:utils.fieldname
         ('person', 'lastname')"/>
     </th>
     <th style="text-align:left;padding-top:0px"
         tal:content="structure python:utils.fieldname ('person', 'function')"/>
     <th style="text-align:left;padding-top:0px"
         tal:content="structure python:utils.fieldname
         ('person', 'description')"/>
     <th style="text-align:left;padding-top:0px" i18n:translate=""
         tal:condition="python:context.is_edit_ok() and remove"
         style="padding-top:0px">
         remove
     </th>
    </tr>
    <tr tal:repeat="p python:
        sorted (persons, key = lambda x: (x.firstname, x.lastname, x.function))">
     <td>
      <span nowrap tal:content="structure python:utils.ExtProperty
       ( utils, p.firstname, item=p
       ).formatlink ()"/>
      <span nowrap tal:content="structure python:utils.ExtProperty
       ( utils, p.lastname, item=p
       ).formatlink ()"/>
     </td>
     <td nowrap>
      <a i18n:translate="" tal:attributes="href python: p.designator ()">
       <span nowrap
        tal:content="python: ' '.join
         (p.function.plain ().split ('\n')[:1])"/>
      </a>
     </td>
     <td nowrap tal:content="structure python:utils.ExtProperty
      ( utils, p.description, item=p
      ).formatlink ()"/>
     <td tal:condition="python:context.is_edit_ok() and remove">
      <input tabindex="-1" type="checkbox" tal:attributes=
             "value python:'-1';
              name  python:'%s@cust_supp' % p.designator ();
             ">
     </td>
    </tr>
</tal:block>

<tal:block metal:define-macro="perslist">
 <tr tal:define="Name python:i18n.gettext (name)">
  <th tal:attributes="rowspan python:len (persons) or 1"
      tal:content="structure python:utils.fieldname ('', name)"/>
  <td colspan="3">
   <table class="form" border="0"
          style="border-spacing:0px;padding-top:0px;padding-left:0px">
    <tal:block metal:use-macro="templates/page/macros/innerperslist"/>
   </table>
  </td>
 </tr>
</tal:block>
